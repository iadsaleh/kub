import asyncio
import os
import signal
import sys
from datetime import datetime
from dotenv import load_dotenv

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ setup_bot_commands Ù…Ù† bot_client Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø²Ø± Ø§Ù„Ù…Ù†ÙŠÙˆ
from modules.bot_client import dp, bot, set_log_queue, setup_bot_commands
from modules.s2s_engine import set_engine_log_queue 
from modules.scheduler import nexus_scheduler
from modules.database import init_db 
from admin_tui import NexusAdmin

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ (Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
try:
    from modules.backup_utils import send_backup_to_admin
except ImportError:
    send_backup_to_admin = None

# ØªØ­Ù…ÙŠÙ„ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© (Ù„Ø¶Ù…Ø§Ù† Ù‚Ø±Ø§Ø¡Ø© ADMIN_ID)
load_dotenv()

# Ø·Ø§Ø¨ÙˆØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¹Ø§Ù„Ù…ÙŠ (The Central Nervous System)
log_queue = asyncio.Queue()

def kill_duplicate_instances():
    """Ù‚ØªÙ„ Ø£ÙŠ Ù†Ø³Ø®Ø© Ù‚Ø¯ÙŠÙ…Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø­Ø¯ÙˆØ« Conflict ÙÙŠ Termux"""
    current_pid = os.getpid()
    if not os.path.exists('/proc'): return
    pids = [pid for pid in os.listdir('/proc') if pid.isdigit()]
    for pid in pids:
        try:
            with open(os.path.join('/proc', pid, 'cmdline'), 'rb') as f:
                cmdline = f.read().decode().replace('\x00', ' ')
                if 'python' in cmdline and 'main.py' in cmdline and int(pid) != current_pid:
                    os.kill(int(pid), signal.SIGKILL)
        except:
            continue

async def log_worker(app):
    """Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø·Ø§Ø¨ÙˆØ± ÙˆØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© TUI Ù„Ø­Ø¸ÙŠØ§Ù‹"""
    while True:
        message = await log_queue.get()
        try:
            log_widget = app.query_one("#logs")
            timestamp = datetime.now().strftime('%H:%M:%S')
            log_widget.write(f"â•‘[{timestamp}] {message}")
        except Exception:
            pass
        finally:
            log_queue.task_done()

# --- Ù…Ù‡Ù…Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Auto Backup Task) ---
async def scheduled_backup_task(bot_instance):
    """Ù…Ù‡Ù…Ø© Ø®Ù„ÙÙŠØ© Ù„Ø¹Ù…Ù„ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙƒÙ„ 12 Ø³Ø§Ø¹Ø©"""
    if not send_backup_to_admin:
        await log_queue.put("[yellow]âš ï¸ Backup module not found. Auto-backup disabled.[/]")
        return

    await log_queue.put("[blue]â³ Auto-backup scheduler started (Every 12h).[/]")
    while True:
        # Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± 12 Ø³Ø§Ø¹Ø© (43200 Ø«Ø§Ù†ÙŠØ©)
        await asyncio.sleep(12 * 60 * 60) 
        
        admin_id = os.getenv("ADMIN_ID")
        if admin_id:
            try:
                await send_backup_to_admin(bot_instance, int(admin_id))
                await log_queue.put("[green]âœ… Auto-backup sent successfully to Admin.[/]")
            except Exception as e:
                await log_queue.put(f"[red]âš ï¸ Auto-backup failed: {e}[/]")

class NexusManager(NexusAdmin):
    """Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒÙ„ÙŠØ© Ù…Ù† Ø¯Ø§Ø®Ù„ ÙˆØ§Ø¬Ù‡Ø© Textual Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ©"""
    
    async def on_mount(self) -> None:
        # 1. ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (SQLite)
        try:
            init_db()
            await log_queue.put("[bold blue]ğŸ“¦ Database Initialized & Connected.[/]")
        except Exception as e:
            await log_queue.put(f"[bold red]âŒ DB Error:[/] {e}")

        # 2. Ø­Ù‚Ù† Ø§Ù„Ø·Ø§Ø¨ÙˆØ± ÙÙŠ ÙƒØ§ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø§Øª
        set_log_queue(log_queue)         
        set_engine_log_queue(log_queue)  
        
        # 3. ØªÙ†Ø¸ÙŠÙ Ø¬Ù„Ø³Ø© ØªÙ„Ø¬Ø±Ø§Ù… ÙˆØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±Ø³Ù…ÙŠØ©
        await bot.delete_webhook(drop_pending_updates=True)
        # ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ù…Ù†ÙŠÙˆ (start / help) Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ØªÙ†Ù‚Ù„
        await setup_bot_commands(bot) 
        await log_queue.put("[bold green]âœ… Telegram Session & Commands Initialized.[/]")
        
        # 4. Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„ (Scheduler)
        nexus_scheduler.start()
        await log_queue.put("[bold magenta]â° Scheduler Engine Active.[/]")
        
        # 5. ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ù‡Ø§Ù… Ø§Ù„Ø®Ù„ÙÙŠØ©
        asyncio.create_task(log_worker(self))
        
        # ØªØ´ØºÙŠÙ„ Ù…Ù‡Ù…Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        asyncio.create_task(scheduled_backup_task(bot))
        
        # ØªÙ…Ø±ÙŠØ± ADMIN_ID Ù„Ø¶Ù…Ø§Ù† ÙˆØµÙˆÙ„Ù‡ Ø¥Ù„Ù‰ Ø§Ù„Ù€ dispatcher Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©
        asyncio.create_task(dp.start_polling(bot, handle_signals=False))
        
        await log_queue.put("[bold gold1]ğŸš€ KUN NEXUS Online - Waiting for commands...[/]")

    async def on_unmount(self) -> None:
        """Ø¥ØºÙ„Ø§Ù‚ Ù†Ø¸ÙŠÙ ÙˆØ¢Ù…Ù† Ù„ÙƒØ§ÙØ© Ø§Ù„Ø§ØªØµØ§Ù„Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬"""
        try:
            nexus_scheduler.shutdown()
            await bot.session.close()
        except:
            pass

if __name__ == "__main__":
    # ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù…ÙƒØ±Ø±Ø© ÙÙŠ Termux
    kill_duplicate_instances()
    
    app = NexusManager()
    try:
        app.run()
    except Exception as e:
        print(f"âŒ Critical System Failure: {e}")
