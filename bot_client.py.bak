import os
import asyncio
import secrets
import json
from datetime import datetime, timedelta
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import CommandObject, CommandStart # Ø¥Ø¶Ø§ÙØ© CommandStart Ù„Ø¯Ø¹Ù… Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.utils.keyboard import InlineKeyboardBuilder
from dotenv import load_dotenv

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø­Ø±ÙƒØŒ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ù‚Ø³Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ
from .s2s_engine import kun_engine
from .database import SessionLocal, User, History, Game, Coupon, GameTimeline
from .educational import register_edu_handlers, get_edu_menu_kb
from .admin_panel import register_admin_handlers 
from .scheduler import nexus_scheduler

# 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
load_dotenv()
TOKEN = os.getenv("BOT_TOKEN")

# 2. ØªØ¹Ø±ÙŠÙ Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø§Ù„Ù…Ø­Ø¯Ø«Ø© (FSM)
class NexusFlow(StatesGroup):
    main_menu = State()
    searching_game = State()        
    selecting_timing = State()      
    waiting_for_levels = State()    
    waiting_for_sniper_lvl = State() 
    waiting_for_profile = State()   
    updating_gaid = State()          
    viewing_history = State()
    waiting_for_coupon = State() 
    waiting_for_custom_plan = State()

# 3. ØªØ¹Ø±ÙŠÙ ÙƒØ§Ø¦Ù†Ø§Øª Ø§Ù„Ø¨ÙˆØª ÙˆØ§Ù„Ø¯ÙŠØ³Ø¨Ø§ØªØ´Ø±
bot = Bot(token=TOKEN)
dp = Dispatcher()

# Ø¬Ø³Ø± Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¯ÙŠØ± (TUI)
log_queue = None
def set_log_queue(q: asyncio.Queue):
    global log_queue
    log_queue = q

async def send_log(msg: str):
    if log_queue is not None:
        try:
            log_queue.put_nowait(msg)
        except Exception: pass

# --- Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø¯Ø§Ø¯ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª ---
async def setup_bot_commands(bot: Bot):
    commands = [
        types.BotCommand(command="start", description="ğŸš€ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"),
        types.BotCommand(command="admin", description="ğŸ› ï¸ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±"),
        types.BotCommand(command="help", description="ğŸ“š Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ")
    ]
    await bot.set_my_commands(commands)

# --- Ø¯Ø§Ù„Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠ (Finance Logic) ---
def get_current_op_price():
    try:
        if os.path.exists("op_price.txt"):
            with open("op_price.txt", "r") as f:
                return float(f.read().strip())
        return 0.05
    except: return 0.05

# --- Ø¯Ø§Ù„Ø§Øª Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (DB Wrappers) ---
def db_get_user(tg_id):
    session = SessionLocal()
    user = session.query(User).filter(User.id == tg_id).first()
    if not user:
        user = User(id=tg_id, balance=0.0, profile_data={"saved_gaid": "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¶Ø¨Ø· âŒ", "total_ops": 0})
        session.add(user)
        session.commit()
        session.refresh(user)
    session.close()
    return user

def db_update_user_profile(tg_id, new_gaid=None, inc_ops=False, charge_amount=0.0):
    session = SessionLocal()
    user = session.query(User).filter(User.id == tg_id).first()
    if user:
        p_data = dict(user.profile_data)
        if new_gaid: p_data["saved_gaid"] = new_gaid
        if inc_ops: p_data["total_ops"] = p_data.get("total_ops", 0) + 1
        user.profile_data = p_data
        if charge_amount != 0.0:
            user.balance -= charge_amount
        session.commit()
    session.close()

def db_log_history(tg_id, game, platform, event, status, resp):
    session = SessionLocal()
    new_entry = History(
        user_id=tg_id, game_alias=game, platform=platform,
        event_name=event, status_code=status, response_text=str(resp)[:200]
    )
    session.add(new_entry)
    session.commit()
    session.close()

# --- Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø© ÙˆØ§Ù„ØªØ­ÙƒÙ… ---
def add_nav_buttons(builder: InlineKeyboardBuilder):
    builder.row(
        types.InlineKeyboardButton(text="â¬…ï¸ Ø¹ÙˆØ¯Ø©", callback_data="back_to_prev"),
        types.InlineKeyboardButton(text="ğŸ  Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", callback_data="back_to_main")
    )

def get_back_to_main_kb():
    builder = InlineKeyboardBuilder()
    builder.row(types.InlineKeyboardButton(text="ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", callback_data="back_to_main"))
    return builder.as_markup()

def get_main_menu_kb():
    builder = InlineKeyboardBuilder()
    builder.row(types.InlineKeyboardButton(text="ğŸ® Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨", callback_data="start_attack"))
    builder.row(types.InlineKeyboardButton(text="ğŸ‘¤ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ÙˆØ§Ù„Ù…Ø¹Ø±ÙØ§Øª", callback_data="my_profile"))
    builder.row(types.InlineKeyboardButton(text="ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª", callback_data="edu_main"))
    builder.row(types.InlineKeyboardButton(text="ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ (Start)", callback_data="reset_bot"))
    return builder.as_markup()

def get_timing_kb():
    builder = InlineKeyboardBuilder()
    builder.row(types.InlineKeyboardButton(text="ğŸ§  Smart AI (Ø¢Ù…Ù†)", callback_data="time:smart"))
    builder.row(types.InlineKeyboardButton(text="ğŸš€ Fast (Ø³Ø±ÙŠØ¹)", callback_data="time:fast"))
    builder.row(types.InlineKeyboardButton(text="ğŸï¸ Turbo (Ø®Ø§Ø±Ù‚)", callback_data="time:turbo"))
    add_nav_buttons(builder)
    return builder.as_markup()

# --- Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Start Command & Deep Linking) ---
@dp.message(CommandStart())
async def cmd_start(message: types.Message, state: FSMContext, command: CommandObject):
    user = db_get_user(message.from_user.id)
    await state.set_state(NexusFlow.main_menu)
    
    # ğŸ†• Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø³Ø­Ø±ÙŠ (Deep Linking) Ù„Ø±Ø¨Ø· Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
    args = command.args
    if args and args.startswith("LINK_DEVICE_"):
        try:
            # Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: LINK_DEVICE_AndroidID__ModelName
            payload = args.replace("LINK_DEVICE_", "")
            
            if "__" in payload:
                android_id, model_safe = payload.split("__", 1)
                model = model_safe.replace("_", " ")
            else:
                android_id = payload
                model = "Unknown Device"

            # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            session = SessionLocal()
            db_user = session.query(User).filter(User.id == message.from_user.id).first()
            if db_user:
                p_data = dict(db_user.profile_data or {})
                p_data['android_id'] = android_id
                p_data['device_model'] = model
                db_user.profile_data = p_data
                session.commit()
            session.close()

            await message.answer(
                f"ğŸ‰ **ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ù†Ø¬Ø§Ø­!**\n\n"
                f"ğŸ“² Ø§Ù„Ø¬Ù‡Ø§Ø²: `{model}`\n"
                f"ğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù: `{android_id}`\n\n"
                f"ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª Ù„Ù„ÙƒØ³Ø±.",
                reply_markup=get_main_menu_kb()
            )
            return # Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù‡Ù†Ø§
            
        except Exception as e:
            await message.answer(f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±Ø¨Ø·: {e}")

    # Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ÙŠØ© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
    await message.answer(f"ğŸš€ **KUN S2S Nexus Edition**\nØ§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø¹ÙƒØ³ÙŠØ©.", reply_markup=get_main_menu_kb())

@dp.callback_query(F.data == "reset_bot")
async def reset_logic(callback: types.CallbackQuery, state: FSMContext):
    await state.clear()
    # Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Start ÙŠØ¯ÙˆÙŠØ§Ù‹
    await callback.message.edit_text("ğŸš€ **KUN S2S Nexus Edition**\nØ§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø¹ÙƒØ³ÙŠØ©.", reply_markup=get_main_menu_kb())
    await callback.answer("ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ğŸ”„")

# --- Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ÙˆÙ†Ø¸Ø§Ù… Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª ---
@dp.callback_query(F.data == "my_profile")
async def show_profile(callback: types.CallbackQuery, state: FSMContext):
    user = db_get_user(callback.from_user.id)
    p_data = user.profile_data
    profile_text = (
        f"ğŸ‘¤ **Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø®Ø¨ÙŠØ±**\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        f"ğŸ†” **ID:** `{user.id}`\nğŸ… **Ø§Ù„Ø±ØªØ¨Ø©:** `VIP Developer`\n"
        f"ğŸ’° **Ø§Ù„Ø±ØµÙŠØ¯:** `${user.balance:.2f}`\n\n"
        f"ğŸ“± **GAID Ø§Ù„Ù…Ø­ÙÙˆØ¸:**\n`{p_data.get('saved_gaid')}`\n"
        f"ğŸ†” **Android ID:** `{p_data.get('android_id', 'ØºÙŠØ± Ù…Ø±Ø¨ÙˆØ·')}`\n\n"
        f"ğŸ“Š **Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª:** `{p_data.get('total_ops')}`\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    )
    builder = InlineKeyboardBuilder()
    builder.row(types.InlineKeyboardButton(text="ğŸ“ ØªØ­Ø¯ÙŠØ« GAID Ø§Ù„Ø¯Ø§Ø¦Ù…", callback_data="update_gaid_manual"))
    builder.row(types.InlineKeyboardButton(text="ğŸŸï¸ Ø´Ø­Ù† Ø¹Ø¨Ø± ÙƒÙˆØ¯ (Coupon)", callback_data="use_coupon"))
    builder.row(types.InlineKeyboardButton(text="ğŸ  Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", callback_data="back_to_main"))
    await callback.message.edit_text(profile_text, reply_markup=builder.as_markup(), parse_mode="Markdown")

@dp.callback_query(F.data == "use_coupon")
async def coupon_input_start(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(NexusFlow.waiting_for_coupon)
    await callback.message.answer("ğŸ“¥ Ø£Ø±Ø³Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø´Ø­Ù† (Coupon) Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:")

@dp.message(NexusFlow.waiting_for_coupon)
async def process_coupon_redemption(message: types.Message, state: FSMContext):
    code = message.text.strip()
    session = SessionLocal()
    coupon = session.query(Coupon).filter(Coupon.code == code, Coupon.is_used == False).first()
    if coupon:
        user = session.query(User).filter(User.id == message.from_user.id).first()
        user.balance += coupon.amount
        coupon.is_used = True
        session.commit()
        await message.answer(f"ğŸ‰ ØªÙ… Ø´Ø­Ù† `${coupon.amount}` Ø¨Ù†Ø¬Ø§Ø­!\nØ±ØµÙŠØ¯Ùƒ: `${user.balance:.2f}`", reply_markup=get_back_to_main_kb())
        await state.set_state(NexusFlow.main_menu)
    else:
        await message.answer("âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ø³ØªØ®Ø¯Ù….")
    session.close()

# --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø£Ø­Ø¯Ø§Ø« (Ù…Ø­Ø¯Ø« Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª) ---
@dp.callback_query(F.data == "start_attack")
async def start_search_logic(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(NexusFlow.searching_game)
    builder = InlineKeyboardBuilder()
    builder.row(types.InlineKeyboardButton(text="ğŸ  Ø¹ÙˆØ¯Ø©", callback_data="back_to_main"))
    await callback.message.edit_text("ğŸ” Ø£Ø±Ø³Ù„ Ø§Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ù„Ø¨Ø­Ø«:", reply_markup=builder.as_markup())

@dp.message(NexusFlow.searching_game)
async def process_game_search(message: types.Message, state: FSMContext):
    query = message.text.lower()
    session = SessionLocal()
    results = session.query(Game).filter(
        (Game.name.ilike(f"%{query}%")) | (Game.alias.ilike(f"%{query}%"))
    ).limit(20).all()
    session.close()
    
    if not results:
        await message.answer("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.")
        return
        
    builder = InlineKeyboardBuilder()
    for game_obj in results:
        display_name = game_obj.name or game_obj.alias
        builder.row(types.InlineKeyboardButton(text=f"âœ… {display_name[:25]}", callback_data=f"game_select:{game_obj.alias}"))
    
    add_nav_buttons(builder)
    await message.answer(f"ğŸ” Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† '{query}':", reply_markup=builder.as_markup())

@dp.callback_query(F.data.startswith("game_select:"))
async def handle_game_selection(callback: types.CallbackQuery, state: FSMContext):
    game_key = callback.data.split(":")[1]
    
    session = SessionLocal()
    game_obj = session.query(Game).filter(Game.alias == game_key).first()
    session.close()
    
    if not game_obj:
        await callback.answer("âŒ Ø®Ø·Ø£: Ø§Ù„Ù„Ø¹Ø¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", show_alert=True)
        return

    game_data = game_obj.json_data or {}
    provider = game_obj.provider or game_data.get("provider")
    
    if not provider:
        if "app_token" in game_data: provider = "Adjust"
        elif "dev_key" in game_data: provider = "AppsFlyer"
        else: provider = "Unknown"
    
    platform = provider.lower()
    
    await state.update_data(selected_game=game_key, platform=platform)
    game_display_name = game_obj.name
    
    builder = InlineKeyboardBuilder()
    builder.row(types.InlineKeyboardButton(text="ğŸ¯ Sniper Mode", callback_data="mode_sniper"))
    builder.row(types.InlineKeyboardButton(text="ğŸšœ Farm Mode", callback_data="mode_farm"))
    builder.row(types.InlineKeyboardButton(text="ğŸ­ Natural Path (Ø±Ø³Ù…ÙŠ)", callback_data="mode_natural"))
    builder.row(types.InlineKeyboardButton(text="âœï¸ Custom Plan (Ø®Ø§Øµ)", callback_data="mode_custom_plan"))
    add_nav_buttons(builder)
    
    await callback.message.edit_text(
        f"ğŸ¯ Ø§Ù„Ù„Ø¹Ø¨Ø©: `{game_display_name}`\n"
        f"ğŸ“¡ Ø§Ù„Ù…Ù†ØµØ©: `{platform.upper()}`\n"
        f"Ø§Ø®ØªØ± ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:", 
        reply_markup=builder.as_markup()
    )

# --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£ÙˆØ¶Ø§Ø¹ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© (Natural & Custom) ---
@dp.callback_query(F.data == "mode_natural")
async def start_natural_mode(callback: types.CallbackQuery, state: FSMContext):
    data = await state.get_data()
    game_key = data.get("selected_game")
    
    session = SessionLocal()
    game = session.query(Game).filter(Game.alias == game_key).first()
    timelines = session.query(GameTimeline).filter(GameTimeline.game_id == game.id).all() if game else []
    session.close()

    if not timelines:
        await callback.answer("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·Ø© Ø±Ø³Ù…ÙŠØ© (Natural) Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.")
        return

    await state.update_data(exec_mode="natural", timelines_count=len(timelines))
    await callback.message.answer(f"ğŸ­ Ø³ÙŠØªÙ… Ø¬Ø¯ÙˆÙ„Ø© {len(timelines)} Ù…Ø±Ø§Ø­Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ Ù„Ù„Ø¹Ø¨Ø©.\nØ£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª Ù„Ù„Ø¨Ø¯Ø¡: `GAID|ID|AID|UA`")
    await state.set_state(NexusFlow.waiting_for_profile)

import os
import asyncio
import secrets
import json
from datetime import datetime, timedelta
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import CommandObject, CommandStart # Ø¥Ø¶Ø§ÙØ© CommandStart Ù„Ø¯Ø¹Ù… Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup
from aiogram.utils.keyboard import InlineKeyboardBuilder
from dotenv import load_dotenv

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø­Ø±ÙƒØŒ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ù‚Ø³Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ
from .s2s_engine import kun_engine
from .database import SessionLocal, User, History, Game, Coupon, GameTimeline
from .educational import register_edu_handlers, get_edu_menu_kb
from .admin_panel import register_admin_handlers 
from .scheduler import nexus_scheduler

# 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø©
load_dotenv()
TOKEN = os.getenv("BOT_TOKEN")

# 2. ØªØ¹Ø±ÙŠÙ Ø­Ø§Ù„Ø§Øª Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ Ø§Ù„Ù…Ø­Ø¯Ø«Ø© (FSM)
class NexusFlow(StatesGroup):
    main_menu = State()
    searching_game = State()        
    selecting_timing = State()      
    waiting_for_levels = State()    
    waiting_for_sniper_lvl = State() 
    waiting_for_profile = State()   
    updating_gaid = State()          
    viewing_history = State()
    waiting_for_coupon = State() 
    waiting_for_custom_plan = State()

# 3. ØªØ¹Ø±ÙŠÙ ÙƒØ§Ø¦Ù†Ø§Øª Ø§Ù„Ø¨ÙˆØª ÙˆØ§Ù„Ø¯ÙŠØ³Ø¨Ø§ØªØ´Ø±
bot = Bot(token=TOKEN)
dp = Dispatcher()

# Ø¬Ø³Ø± Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¯ÙŠØ± (TUI)
log_queue = None
def set_log_queue(q: asyncio.Queue):
    global log_queue
    log_queue = q

async def send_log(msg: str):
    if log_queue is not None:
        try:
            log_queue.put_nowait(msg)
        except Exception: pass

# --- Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø¯Ø§Ø¯ Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ø¨ÙˆØª ---
async def setup_bot_commands(bot: Bot):
    commands = [
        types.BotCommand(command="start", description="ğŸš€ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©"),
        types.BotCommand(command="admin", description="ğŸ› ï¸ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±"),
        types.BotCommand(command="help", description="ğŸ“š Ø§Ù„Ø¯Ù„ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ")
    ]
    await bot.set_my_commands(commands)

# --- Ø¯Ø§Ù„Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø§Ù„ÙŠ (Finance Logic) ---
def get_current_op_price():
    try:
        if os.path.exists("op_price.txt"):
            with open("op_price.txt", "r") as f:
                return float(f.read().strip())
        return 0.05
    except: return 0.05

# --- Ø¯Ø§Ù„Ø§Øª Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (DB Wrappers) ---
def db_get_user(tg_id):
    session = SessionLocal()
    user = session.query(User).filter(User.id == tg_id).first()
    if not user:
        user = User(id=tg_id, balance=0.0, profile_data={"saved_gaid": "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¶Ø¨Ø· âŒ", "total_ops": 0})
        session.add(user)
        session.commit()
        session.refresh(user)
    session.close()
    return user

def db_update_user_profile(tg_id, new_gaid=None, inc_ops=False, charge_amount=0.0):
    session = SessionLocal()
    user = session.query(User).filter(User.id == tg_id).first()
    if user:
        p_data = dict(user.profile_data)
        if new_gaid: p_data["saved_gaid"] = new_gaid
        if inc_ops: p_data["total_ops"] = p_data.get("total_ops", 0) + 1
        user.profile_data = p_data
        if charge_amount != 0.0:
            user.balance -= charge_amount
        session.commit()
    session.close()

def db_log_history(tg_id, game, platform, event, status, resp):
    session = SessionLocal()
    new_entry = History(
        user_id=tg_id, game_alias=game, platform=platform,
        event_name=event, status_code=status, response_text=str(resp)[:200]
    )
    session.add(new_entry)
    session.commit()
    session.close()

# --- Ø¯Ø§Ù„Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø© ÙˆØ§Ù„ØªØ­ÙƒÙ… ---
def add_nav_buttons(builder: InlineKeyboardBuilder):
    builder.row(
        types.InlineKeyboardButton(text="â¬…ï¸ Ø¹ÙˆØ¯Ø©", callback_data="back_to_prev"),
        types.InlineKeyboardButton(text="ğŸ  Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", callback_data="back_to_main")
    )

def get_back_to_main_kb():
    builder = InlineKeyboardBuilder()
    builder.row(types.InlineKeyboardButton(text="ğŸ  Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", callback_data="back_to_main"))
    return builder.as_markup()

def get_main_menu_kb():
    builder = InlineKeyboardBuilder()
    builder.row(types.InlineKeyboardButton(text="ğŸ® Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù„Ø¹Ø§Ø¨", callback_data="start_attack"))
    builder.row(types.InlineKeyboardButton(text="ğŸ‘¤ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ÙˆØ§Ù„Ù…Ø¹Ø±ÙØ§Øª", callback_data="my_profile"))
    builder.row(types.InlineKeyboardButton(text="ğŸ“Š Ø³Ø¬Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª", callback_data="edu_main"))
    builder.row(types.InlineKeyboardButton(text="ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ (Start)", callback_data="reset_bot"))
    return builder.as_markup()

def get_timing_kb():
    builder = InlineKeyboardBuilder()
    builder.row(types.InlineKeyboardButton(text="ğŸ§  Smart AI (Ø¢Ù…Ù†)", callback_data="time:smart"))
    builder.row(types.InlineKeyboardButton(text="ğŸš€ Fast (Ø³Ø±ÙŠØ¹)", callback_data="time:fast"))
    builder.row(types.InlineKeyboardButton(text="ğŸï¸ Turbo (Ø®Ø§Ø±Ù‚)", callback_data="time:turbo"))
    add_nav_buttons(builder)
    return builder.as_markup()

# --- Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Start Command & Deep Linking) ---
@dp.message(CommandStart())
async def cmd_start(message: types.Message, state: FSMContext, command: CommandObject):
    user = db_get_user(message.from_user.id)
    await state.set_state(NexusFlow.main_menu)
    
    # ğŸ†• Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ø³Ø­Ø±ÙŠ (Deep Linking) Ù„Ø±Ø¨Ø· Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
    args = command.args
    if args and args.startswith("LINK_DEVICE_"):
        try:
            # Ø§Ù„Ù…ØªÙˆÙ‚Ø¹: LINK_DEVICE_AndroidID__ModelName
            payload = args.replace("LINK_DEVICE_", "")
            
            if "__" in payload:
                android_id, model_safe = payload.split("__", 1)
                model = model_safe.replace("_", " ")
            else:
                android_id = payload
                model = "Unknown Device"

            # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            session = SessionLocal()
            db_user = session.query(User).filter(User.id == message.from_user.id).first()
            if db_user:
                p_data = dict(db_user.profile_data or {})
                p_data['android_id'] = android_id
                p_data['device_model'] = model
                db_user.profile_data = p_data
                session.commit()
            session.close()

            await message.answer(
                f"ğŸ‰ **ØªÙ… Ø±Ø¨Ø· Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ù†Ø¬Ø§Ø­!**\n\n"
                f"ğŸ“² Ø§Ù„Ø¬Ù‡Ø§Ø²: `{model}`\n"
                f"ğŸ†” Ø§Ù„Ù…Ø¹Ø±Ù: `{android_id}`\n\n"
                f"ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¨ÙˆØª Ù„Ù„ÙƒØ³Ø±.",
                reply_markup=get_main_menu_kb()
            )
            return # Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù‡Ù†Ø§
            
        except Exception as e:
            await message.answer(f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø±Ø¨Ø·: {e}")

    # Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ÙŠØ© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
    await message.answer(f"ğŸš€ **KUN S2S Nexus Edition**\nØ§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø¹ÙƒØ³ÙŠØ©.", reply_markup=get_main_menu_kb())

@dp.callback_query(F.data == "reset_bot")
async def reset_logic(callback: types.CallbackQuery, state: FSMContext):
    await state.clear()
    # Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Start ÙŠØ¯ÙˆÙŠØ§Ù‹
    await callback.message.edit_text("ğŸš€ **KUN S2S Nexus Edition**\nØ§Ù„Ù…Ù†ØµØ© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠØ© Ù„Ù„Ù‡Ù†Ø¯Ø³Ø© Ø§Ù„Ø¹ÙƒØ³ÙŠØ©.", reply_markup=get_main_menu_kb())
    await callback.answer("ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… ğŸ”„")

# --- Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ÙˆÙ†Ø¸Ø§Ù… Ø§Ù„ÙƒÙˆØ¨ÙˆÙ†Ø§Øª ---
@dp.callback_query(F.data == "my_profile")
async def show_profile(callback: types.CallbackQuery, state: FSMContext):
    user = db_get_user(callback.from_user.id)
    p_data = user.profile_data
    profile_text = (
        f"ğŸ‘¤ **Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø®Ø¨ÙŠØ±**\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n"
        f"ğŸ†” **ID:** `{user.id}`\nğŸ… **Ø§Ù„Ø±ØªØ¨Ø©:** `VIP Developer`\n"
        f"ğŸ’° **Ø§Ù„Ø±ØµÙŠØ¯:** `${user.balance:.2f}`\n\n"
        f"ğŸ“± **GAID Ø§Ù„Ù…Ø­ÙÙˆØ¸:**\n`{p_data.get('saved_gaid')}`\n"
        f"ğŸ†” **Android ID:** `{p_data.get('android_id', 'ØºÙŠØ± Ù…Ø±Ø¨ÙˆØ·')}`\n\n"
        f"ğŸ“Š **Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª:** `{p_data.get('total_ops')}`\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    )
    builder = InlineKeyboardBuilder()
    builder.row(types.InlineKeyboardButton(text="ğŸ“ ØªØ­Ø¯ÙŠØ« GAID Ø§Ù„Ø¯Ø§Ø¦Ù…", callback_data="update_gaid_manual"))
    builder.row(types.InlineKeyboardButton(text="ğŸŸï¸ Ø´Ø­Ù† Ø¹Ø¨Ø± ÙƒÙˆØ¯ (Coupon)", callback_data="use_coupon"))
    builder.row(types.InlineKeyboardButton(text="ğŸ  Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©", callback_data="back_to_main"))
    await callback.message.edit_text(profile_text, reply_markup=builder.as_markup(), parse_mode="Markdown")

@dp.callback_query(F.data == "use_coupon")
async def coupon_input_start(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(NexusFlow.waiting_for_coupon)
    await callback.message.answer("ğŸ“¥ Ø£Ø±Ø³Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø´Ø­Ù† (Coupon) Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:")

@dp.message(NexusFlow.waiting_for_coupon)
async def process_coupon_redemption(message: types.Message, state: FSMContext):
    code = message.text.strip()
    session = SessionLocal()
    coupon = session.query(Coupon).filter(Coupon.code == code, Coupon.is_used == False).first()
    if coupon:
        user = session.query(User).filter(User.id == message.from_user.id).first()
        user.balance += coupon.amount
        coupon.is_used = True
        session.commit()
        await message.answer(f"ğŸ‰ ØªÙ… Ø´Ø­Ù† `${coupon.amount}` Ø¨Ù†Ø¬Ø§Ø­!\nØ±ØµÙŠØ¯Ùƒ: `${user.balance:.2f}`", reply_markup=get_back_to_main_kb())
        await state.set_state(NexusFlow.main_menu)
    else:
        await message.answer("âŒ Ø§Ù„ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ù…Ø³ØªØ®Ø¯Ù….")
    session.close()

# --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„Ø£Ø­Ø¯Ø§Ø« (Ù…Ø­Ø¯Ø« Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª) ---
@dp.callback_query(F.data == "start_attack")
async def start_search_logic(callback: types.CallbackQuery, state: FSMContext):
    await state.set_state(NexusFlow.searching_game)
    builder = InlineKeyboardBuilder()
    builder.row(types.InlineKeyboardButton(text="ğŸ  Ø¹ÙˆØ¯Ø©", callback_data="back_to_main"))
    await callback.message.edit_text("ğŸ” Ø£Ø±Ø³Ù„ Ø§Ø³Ù… Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ù„Ø¨Ø­Ø«:", reply_markup=builder.as_markup())

@dp.message(NexusFlow.searching_game)
async def process_game_search(message: types.Message, state: FSMContext):
    query = message.text.lower()
    session = SessionLocal()
    results = session.query(Game).filter(
        (Game.name.ilike(f"%{query}%")) | (Game.alias.ilike(f"%{query}%"))
    ).limit(20).all()
    session.close()
    
    if not results:
        await message.answer("âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬.")
        return
        
    builder = InlineKeyboardBuilder()
    for game_obj in results:
        display_name = game_obj.name or game_obj.alias
        builder.row(types.InlineKeyboardButton(text=f"âœ… {display_name[:25]}", callback_data=f"game_select:{game_obj.alias}"))
    
    add_nav_buttons(builder)
    await message.answer(f"ğŸ” Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† '{query}':", reply_markup=builder.as_markup())

@dp.callback_query(F.data.startswith("game_select:"))
async def handle_game_selection(callback: types.CallbackQuery, state: FSMContext):
    game_key = callback.data.split(":")[1]
    
    session = SessionLocal()
    game_obj = session.query(Game).filter(Game.alias == game_key).first()
    session.close()
    
    if not game_obj:
        await callback.answer("âŒ Ø®Ø·Ø£: Ø§Ù„Ù„Ø¹Ø¨Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª", show_alert=True)
        return

    game_data = game_obj.json_data or {}
    provider = game_obj.provider or game_data.get("provider")
    
    if not provider:
        if "app_token" in game_data: provider = "Adjust"
        elif "dev_key" in game_data: provider = "AppsFlyer"
        else: provider = "Unknown"
    
    platform = provider.lower()
    
    await state.update_data(selected_game=game_key, platform=platform)
    game_display_name = game_obj.name
    
    builder = InlineKeyboardBuilder()
    builder.row(types.InlineKeyboardButton(text="ğŸ¯ Sniper Mode", callback_data="mode_sniper"))
    builder.row(types.InlineKeyboardButton(text="ğŸšœ Farm Mode", callback_data="mode_farm"))
    builder.row(types.InlineKeyboardButton(text="ğŸ­ Natural Path (Ø±Ø³Ù…ÙŠ)", callback_data="mode_natural"))
    builder.row(types.InlineKeyboardButton(text="âœï¸ Custom Plan (Ø®Ø§Øµ)", callback_data="mode_custom_plan"))
    add_nav_buttons(builder)
    
    await callback.message.edit_text(
        f"ğŸ¯ Ø§Ù„Ù„Ø¹Ø¨Ø©: `{game_display_name}`\n"
        f"ğŸ“¡ Ø§Ù„Ù…Ù†ØµØ©: `{platform.upper()}`\n"
        f"Ø§Ø®ØªØ± ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:", 
        reply_markup=builder.as_markup()
    )

# --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£ÙˆØ¶Ø§Ø¹ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© (Natural & Custom) ---
@dp.callback_query(F.data == "mode_natural")
async def start_natural_mode(callback: types.CallbackQuery, state: FSMContext):
    data = await state.get_data()
    game_key = data.get("selected_game")
    
    session = SessionLocal()
    game = session.query(Game).filter(Game.alias == game_key).first()
    timelines = session.query(GameTimeline).filter(GameTimeline.game_id == game.id).all() if game else []
    session.close()

    if not timelines:
        await callback.answer("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø®Ø·Ø© Ø±Ø³Ù…ÙŠØ© (Natural) Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.")
        return

    await state.update_data(exec_mode="natural", timelines_count=len(timelines))
    await callback.message.answer(f"ğŸ­ Ø³ÙŠØªÙ… Ø¬Ø¯ÙˆÙ„Ø© {len(timelines)} Ù…Ø±Ø§Ø­Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø®Ø·Ø· Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠ Ù„Ù„Ø¹Ø¨Ø©.\nØ£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª Ù„Ù„Ø¨Ø¯Ø¡: `GAID|ID|AID|UA`")
    await state.set_state(NexusFlow.waiting_for_profile)