import httpx
import json
import time
import random
import re
import asyncio
from datetime import datetime, timedelta

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ù„Ø¹Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯)
# ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø³Ø§Ø± Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„ØµØ­ÙŠØ­ Ø³ÙˆØ§Ø¡ ØªÙ… Ø§Ù„ØªØ´ØºÙŠÙ„ Ù…Ù† Ø§Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„ÙØ±Ø¹ÙŠ Ø£Ùˆ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
try:
    from database import SessionLocal, Game
except ImportError:
    from .database import SessionLocal, Game

# Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø·Ø§Ø¨ÙˆØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„Ø¥Ø¸Ù‡Ø§Ø± ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø¯ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
try:
    from main import log_queue
except ImportError:
    log_queue = None

class KUNNexusEngine:
    def __init__(self):
        # ØªÙ… Ø¥Ù„ØºØ§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆÙ†ÙÙŠØº Ù…Ù† Ø§Ù„Ù…Ù„ÙØŒ Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ø¢Ù† ÙƒÙ„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        # Ù‡Ø°Ø§ ÙŠÙ…Ù†Ø¹ Ø®Ø·Ø£ FileNotFoundError: config.json
        pass

    async def send_log(self, message: str):
        """Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¯ÙŠØ± TUI"""
        global log_queue
        if log_queue:
            try:
                await log_queue.put(message)
            except:
                pass

    # --- Ù…Ù†Ø·Ù‚ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø°ÙƒÙŠ (Ù…Ù‚ØªØ¨Ø³ Ù…Ù† ÙƒÙˆØ¯Ùƒ Ø§Ù„Ù†Ø§Ø¬Ø­) ---
    def calculate_smart_sleep(self, level_str, platform):
        try:
            num = int(re.search(r'\d+', str(level_str)).group())
        except: 
            num = 1
        
        if platform == "adjust":
            base = 45 + (num * 10)
            if base > 900: base = 900
        else: # AppsFlyer / Singular
            base = 45 + (num * 12)
            if base > 1200: base = 1200
            
        jitter = int(base * 0.2)
        return max(30, base + random.randint(-jitter, jitter))

    async def send_event(self, game_key, event_data, user_profile):
        # 1. Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        session = SessionLocal()
        try:
            game_obj = session.query(Game).filter(Game.alias == game_key).first()
            
            if not game_obj: 
                return 404, "Game Key Missing in DB"
            
            if not game_obj.is_active:
                return 403, "Game is disabled"

            # ØªØ¬Ù‡ÙŠØ² Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ù…Ù† Ø¹Ù…ÙˆØ¯ json_data Ø§Ù„Ø°ÙŠ Ù†Ù‚Ù„Ù†Ø§ Ø¥Ù„ÙŠÙ‡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            game_config = game_obj.json_data.copy() if game_obj.json_data else {}
            # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙˆØ¯ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙˆÙØ±Ù‡ Ù„Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ§Ù„ÙŠ
            game_config['provider'] = game_obj.provider
            
        finally:
            session.close() # Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¬Ù„Ø³Ø© ÙÙˆØ±Ø§Ù‹ Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
        
        # 2. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†ØµØ© (ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯ provider ÙˆØ§Ù„Ù‚Ø¯ÙŠÙ… platform)
        raw_platform = game_config.get("provider") or game_config.get("platform") or "appsflyer"
        platform = raw_platform.lower()
        
        async with httpx.AsyncClient(http2=True, verify=False, timeout=30.0) as client:
            if "appsflyer" in platform:
                return await self._fire_appsflyer(client, game_config, event_data, user_profile)
            elif "adjust" in platform:
                return await self._fire_adjust(client, game_config, event_data, user_profile)
            elif "singular" in platform:
                return await self._fire_singular(client, game_config, event_data, user_profile)
            else:
                return 400, f"Platform {platform} not implemented"

    async def _fire_appsflyer(self, client, game, event_data, user):
        url = f"https://api2.appsflyer.com/inappevent/{game['app_id']}"
        
        processing_lag_ms = random.randint(500, 2500)
        simulated_time = datetime.utcnow() - timedelta(milliseconds=processing_lag_ms)
        event_time = simulated_time.strftime('%Y-%m-%d %H:%M:%S.%f')[:-3]

        lvl = event_data.get('level', '1')
        padding = game.get('padding', 0)
        lvl_str = str(lvl).zfill(padding) if padding > 0 else str(lvl)

        templates = game.get('event_templates', {})
        level_template = templates.get('level_up')
        
        if level_template:
            event_name = level_template['event_name'].replace("{LEVEL}", lvl_str)
            event_value = level_template['json_template'].replace("{LEVEL}", lvl_str)
            if "{GAID}" in event_value:
                event_value = event_value.replace("{GAID}", user.get("gaid", ""))
        else:
            event_name = str(event_data.get('name', "level_completed")).replace("{LEVEL}", lvl_str)
            event_value = json.dumps({"level": lvl_str})

        # Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø¹Ø±Ù: Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø«Ù… Ø§Ù„ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ
        af_id = user.get("af_id") or user.get("appsflyer_uid")
        
        # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ØŒ Ù†ÙˆÙ„Ø¯ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹ (Ù…Ø­Ø§ÙƒØ§Ø© ØªØ«Ø¨ÙŠØª Ø¬Ø¯ÙŠØ¯)
        if not af_id:
            af_id = f"{int(time.time()*1000)}-{random.randint(1000000000000000000, 9223372036854775807)}"

        # Ø¨Ù†Ø§Ø¡ Payload Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠ
        payload = {
            "appsflyer_id": af_id,
            "advertising_id": user.get("gaid"),
            "eventName": event_name,
            "eventValue": event_value,
            "eventTime": event_time,
            "af_events_api": "true"
        }
        
        android_id = user.get("android_id")
        if android_id: payload["android_id"] = android_id
        
        headers = {
            "authentication": game.get('dev_key'),
            "Content-Type": "application/json",
            "User-Agent": user.get("ua") or "Dalvik/2.1.0 (Linux; U; Android 13)",
            "X-Appsflyer-App-ID": game.get('app_id'),
            "Connection": "Keep-Alive"
        }
        
        try:
            await asyncio.sleep(random.uniform(0.1, 0.5))
            resp = await client.post(url, json=payload, headers=headers)
            color = "green" if resp.status_code < 400 else "red"
            await self.send_log(f"[{color}]ğŸ“¡ AF Resp ({resp.status_code}):[/] {resp.text[:100]}")
            return resp.status_code, resp.text
        except Exception as e:
            return 500, str(e)

    async def _fire_adjust(self, client, game, event_data, user):
        url = "https://app.adjust.com/event"
        created_at = datetime.utcnow().strftime('%Y-%m-%dT%H:%M:%S.%fZ')[:-4] + "Z"
        
        # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ GAID
        gps_adid = user.get("gaid")
        # Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ GAIDØŒ Ù†Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… adjust_id ÙƒØ¨Ø¯ÙŠÙ„ Ø£Ùˆ Ù†ØªØ±ÙƒÙ‡ Ù„ÙŠØªÙ… Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹Ù‡
        if not gps_adid:
             gps_adid = user.get("adjust_id")

        params = {
            "s2s": "1",
            "app_token": game.get("app_token"),
            "event_token": event_data.get('token') or event_data.get('name'),
            "gps_adid": gps_adid,
            "created_at": created_at,
            "environment": game.get("environment", "production")
        }
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¹Ø±ÙØ§Øª Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© ÙÙ‚Ø· Ø¥Ø°Ø§ ÙˆØ¬Ø¯Øª Ù„Ù…Ù†Ø¹ Ø±ÙØ¶ Ø§Ù„Ø³ÙŠØ±ÙØ±
        if user.get("adjust_id"): params["adid"] = user.get("adjust_id")
        if user.get("android_id"): params["android_id"] = user.get("android_id")
        if user.get("ip"): params["ip_address"] = user.get("ip")
        
        headers = {
            "User-Agent": user.get("ua") or "Dalvik/2.1.0 (Linux; U; Android 10)",
            "Client-SDK": "android4.28.0" 
        }
        
        try:
            await asyncio.sleep(random.uniform(0.5, 2.0))
            resp = await client.get(url, params=params, headers=headers)
            color = "green" if resp.status_code < 400 else "red"
            await self.send_log(f"[{color}]ğŸ“¡ Adjust Resp ({resp.status_code}):[/] {resp.text[:100]}")
            return resp.status_code, resp.text
        except Exception as e:
            return 500, str(e)

    async def _fire_singular(self, client, game, event_data, user):
        url = "https://sdk-api.singular.net/api/v1/event"
        params = {
            "a": game.get("api_key"),
            "i": game.get("app_id"),
            "p": "android",
            "muid": user.get("gaid"),
            "n": event_data.get('name'),
            "v": event_data.get('value', "{}"),
            "timestamp": str(int(time.time()))
        }
        
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±ÙŠØ© ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ØªÙˆÙØ±Ø©
        if user.get("android_id"): params["andi"] = user.get("android_id")
        if user.get("ip"): params["ip"] = user.get("ip")
        params["ve"] = user.get("sdk_ver") or "S3.1.2"
        
        try:
            resp = await client.get(url, params=params)
            color = "green" if resp.status_code < 400 else "red"
            await self.send_log(f"[{color}]ğŸ“¡ Singular Resp ({resp.status_code}):[/] {resp.text[:100]}")
            return resp.status_code, resp.text
        except Exception as e:
            return 500, str(e)

kun_engine = KUNNexusEngine()

def set_engine_log_queue(q):
    """Ø¯Ø§Ù„Ø© Ù„Ø­Ù‚Ù† Ø·Ø§Ø¨ÙˆØ± Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø­Ø±Ùƒ"""
    global log_queue
    log_queue = q
